---
title: "Note"
output: 
  github_document:
    toc: TRUE
---

## 初始化
- [X] 创建shinyweb工程
- [X] 工作目录下，创建 `data` 和 `utils`文件夹
- [X] `Utils`文件夹下，创建文件 `fct.R`、`serverMod.R`和`uiMod.R`


### app.R

```{r, eval=FALSE}
library(shiny)
library(shinydashboard)
library(DBI)
library(RSQLite)
library(tidyverse)
library(readxl)
library(writexl)
library(httr)
library(rvest)
library(stringr)
library(jsonlite)
library(dplyr)

```


## 数据库操作

```{r, eval=FALSE}
con <- dbConnect(SQLite(), "data/tcmnp.db")
dbDisconnect(con)

```


## 网页抓取
```{r, eval=FALSE}
# tcmsp
url <- "https://old.tcmsp-e.com/tcmspsearch.php?qr=Aconiti%20Lateralis%20Radix%20Praeparata&qsr=herb_en_name&token=62bfada3d007982faa0f349d028461c0"

ingredients_numeric_vars <- c("ob","mw","alogp","caco2","bbb","halflife","hdon","hacc","dl","FASA")
targets_numeric_vars <- c("SVM_score","RF_score")


res <- httr::GET(url, enconding="UTF-8", config(ssl_verifypeer=FALSE)) %>% 
  rvest::read_html() %>% 
  rvest::html_elements("script") %>% 
  rvest::html_text() %>% 
  stringr::str_extract_all(.,"data:\\s\\[.*\\]")
res2 <- unlist(res[12])

ingredients <- stringr::str_replace(res2[1],"data:","") %>% writeLines(.,"tmp.txt")
ingredients_df <- jsonlite::read_json("tmp.txt",simplifyVector = TRUE)
ingredients_df <- ingredients_df %>%
                  mutate(herb = rep("附子",nrow(ingredients_df))) %>%
                  mutate(herb_pinyin = rep("Fu Zi",nrow(ingredients_df))) %>%
                  mutate(herb_latin = rep("Aconiti Lateralis Radix Praeparata",nrow(ingredients_df))) %>%
                  dplyr::select(herb,herb_pinyin,herb_latin,everything()) %>% 
                  lapply(as.factor) %>%
                  as.data.frame

ingredients_df[,ingredients_numeric_vars] <- ingredients_df[,ingredients_numeric_vars] %>% lapply(as.numeric)

ingredients_targets <- stringr::str_replace(res2[2],"data:","") %>% writeLines(.,"tmp.txt")
ingredients_targets_df <- jsonlite::read_json("tmp.txt",simplifyVector = TRUE) %>% 
                          lapply(as.factor) %>%
                          as.data.frame
ingredients_targets_df[,targets_numeric_vars] <- ingredients_targets_df[,targets_numeric_vars] %>% lapply(as.numeric)

file.remove("tmp.txt")
```


## 读入excel数据，表格显示
```{r, eval=FALSE}
db <- reactive({
        rs <- readxl::read_xlsx("data/中药数据库.xlsx") %>% lapply(as.factor) %>% as.data.frame
        rs$数据库 <- paste0('<a href="',rs$网址,'" target="_blank">', rs$数据库, '</a>') %>% as.data.frame
        colnames(rs[,1]) <- "数据库"
        rs <- rs[-ncol(rs)]
        rs
      })
      output$dbList <- renderDT(
        db(), escape = FALSE
      )

```


## 数据库查询，表格显示
```{r, eval=FALSE}
con <- dbConnect(SQLite(),"data/tcmnp.db")

dbWriteTable(con,"tcmdb",rs)

dbWriteTable(con,"formula_herb",rs)
rs <- dbReadTable(con,"formula_herb") %>% lapply(as.factor) %>% as.data.frame

rs <- dbGetQuery(con, 
                 paste0(
                  'SELECT * FROM formula_herb WHERE "方剂名称" = "',
                  input$queryTxt,
                  '" OR "方剂名称拼音" = "',
                  input$queryTxt,
                  '" OR "中药名称" = "',
                  input$queryTxt,
                  '" OR "中药名称拼音" = "',
                  input$queryTxt,
                  '"'
                ))

rs <- dbGetQuery(con, 
                 paste0(
                  'SELECT * FROM formula_herb WHERE "方剂名称" LIKE "%',
                  input$queryTxt,
                  '%" OR "方剂名称拼音" LIKE "%',
                  input$queryTxt,
                  '%" OR "中药名称" LIKE "%',
                  input$queryTxt,
                  '%" OR "中药名称拼音" LIKE "%',
                  input$queryTxt,
                  '%"'
                ))


dbListTables(con)

dbDisconnect(con)

output$formula_herb_db <- renderDT(rs, escape = FALSE,filter = 'top')
output$formula_herb_db <- renderDT(rs, escape = FALSE)
```


# 数据库增删改
```{r, eval=FALSE}

```


```{r, eval=FALSE}

```


```{r, eval=FALSE}

```


```{r, eval=FALSE}

```
